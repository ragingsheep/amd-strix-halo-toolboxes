name: Build & Publish AMD Strix Halo Toolbox (rocm-7.2-Opt)

on:
  workflow_dispatch:

env:
  DOCKERHUB_REPO: docker.io/ragingsheep/amd-strix-halo-toolboxes-optimized
  LOCAL_PREFIX: llama
  BACKEND: rocm-7.2-Opt

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Free up runner disk space
        run: |
          echo "Before cleanup:" && df -h /
          sudo rm -rf \
            /usr/share/dotnet \
            /usr/local/lib/android \
            /opt/ghc \
            /opt/hostedtoolcache/CodeQL
          docker system prune --all --force
          docker builder prune --all --force
          echo "After cleanup:" && df -h /

      - name: Check out repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set build timestamp
        run: echo "BUILD_TS=$(date +%Y%m%dT%H%M%S)" >> $GITHUB_ENV

      - name: Build & push rocm-7.2-Opt
        working-directory: toolboxes
        shell: bash
        run: |
          set -euo pipefail

          DF="Dockerfile.${BACKEND}"
          NAME="${BACKEND}"
          LI="${LOCAL_PREFIX}-${NAME}"
          TAG="${NAME}_${BUILD_TS}"
          IMM="${DOCKERHUB_REPO}:${TAG}"
          CHN="${DOCKERHUB_REPO}:${NAME}"

          echo "→ Building ${DF}"
          docker build --no-cache -t "${LI}" -f "${DF}" .

          echo "→ Tag & push immutable → ${IMM}"
          docker tag "${LI}" "${IMM}"
          docker push "${IMM}"

          echo "→ Tag & push channel → ${CHN}"
          docker tag "${IMM}" "${CHN}"
          docker push "${CHN}"
